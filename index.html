<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Snake ‚Äî Mobile Fixed</title>
  <style>
    html,body{margin:0;padding:0;background:#111;color:#eee;font-family:sans-serif;height:100%;-webkit-user-select:none;user-select:none;}
    button{touch-action:manipulation;}
    .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;min-height:100svh;padding:12px;}
    #game{background:#000;display:block;border-radius:12px;touch-action:none;box-shadow:0 8px 30px rgba(0,0,0,.5);}
    .hud{display:flex;gap:14px;align-items:center;justify-content:space-between;width:min(560px,92vw);}
    .hud .stats{display:flex;gap:14px;align-items:center;}
    .hud .btn{padding:10px 14px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#eee;font-size:16px}
    .controls{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,64px);gap:10px;width:min(420px,92vw);}
    .controls button{background:#1b1b1b;border:1px solid #333;border-radius:14px;color:#eee;font-size:18px}
    .controls .empty{opacity:0}
    .footer{opacity:.7;font-size:12px}
    @media (min-width:700px){ .controls{grid-template-rows:repeat(3,84px);} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="hud">
    <div class="stats">
      <div>Score: <span id="score">0</span></div>
      <div>Best: <span id="best">0</span></div>
      <div>Speed: <span id="speed">1</span>x</div>
    </div>
    <div class="actions">
      <button class="btn" id="pauseBtn">‚èØÔ∏è</button>
      <button class="btn" id="restartBtn">üîÑ</button>
    </div>
  </div>
  <canvas id="game" width="352" height="352"></canvas>

  <div class="controls">
    <div class="empty"></div>
    <button id="up">‚ñ≤</button>
    <div class="empty"></div>
    <button id="left">‚óÄ</button>
    <button id="down">‚ñº</button>
    <button id="right">‚ñ∂</button>
    <div class="empty"></div>
    <button id="boost" class="btn">‚ö°</button>
    <div class="empty"></div>
  </div>
  <div class="footer">Swipe or tap arrows to move. ‚ö° = hold for boost.</div>
</div>
<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const speedEl = document.getElementById('speed');
  const pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn');
  const tile = 16, gridSize = canvas.width / tile | 0;

  let snake, dir, food, score, best, running, baseDelay, boost, tickHandle;

  function randCell(){ return {x: (Math.random()*gridSize|0), y: (Math.random()*gridSize|0)}; }

  function reset(){
    snake = [{x:10,y:10},{x:9,y:10},{x:8,y:10}];
    dir = {x:1,y:0};
    food = placeFood();
    score = 0;
    baseDelay = 120;
    boost = false;
    running = true;
    updateHUD();
    draw();
  }

  function placeFood(){
    let f;
    do { f = randCell(); } while (snake.some(s=>s.x===f.x && s.y===f.y));
    return f;
  }

  function updateHUD(){
    scoreEl.textContent = score;
    best = Math.max(+localStorage.snakeBest||0, score);
    localStorage.snakeBest = best;
    bestEl.textContent = best;
    speedEl.textContent = boost? 2: 1;
    pauseBtn.textContent = running ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
  }

  function step(){
    if(!running) return;
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
    head.x = (head.x + gridSize) % gridSize;
    head.y = (head.y + gridSize) % gridSize;
    if(snake.some((s,i)=> i && s.x===head.x && s.y===head.y)){
      running=false; updateHUD(); return;
    }
    snake.unshift(head);
    if(head.x===food.x && head.y===food.y){
      score+=10; food = placeFood(); baseDelay = Math.max(60, baseDelay - 2);
    } else { snake.pop(); }
    draw();
  }

  function draw(){
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = 'rgba(255,255,255,.05)';
    for(let i=1;i<gridSize;i++){
      ctx.beginPath(); ctx.moveTo(i*tile,0); ctx.lineTo(i*tile,canvas.height); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,i*tile); ctx.lineTo(canvas.width,i*tile); ctx.stroke();
    }
    ctx.fillStyle = '#e43';
    ctx.fillRect(food.x*tile+3, food.y*tile+3, tile-6, tile-6);
    for(let i=0;i<snake.length;i++){
      ctx.fillStyle = i===0 ? '#6cf' : '#4ad';
      ctx.fillRect(snake[i].x*tile+2, snake[i].y*tile+2, tile-4, tile-4);
    }
  }

  function loop(){
    clearTimeout(tickHandle);
    const delay = baseDelay / (boost?2:1);
    tickHandle = setTimeout(()=>{ step(); loop(); }, delay);
  }

  function setDir(nx,ny){
    if(snake.length>1 && nx===-dir.x && ny===-dir.y) return;
    dir = {x:nx,y:ny};
  }

  function bindBtn(id, fnDown){
    const btn = document.getElementById(id);
    btn.addEventListener('touchstart', e=>{ e.preventDefault(); fnDown(); }, {passive:false});
    btn.addEventListener('mousedown', e=>{ e.preventDefault(); fnDown(); });
  }

  bindBtn('up', ()=>setDir(0,-1));
  bindBtn('down', ()=>setDir(0,1));
  bindBtn('left', ()=>setDir(-1,0));
  bindBtn('right', ()=>setDir(1,0));

  // Boost hold
  const boostBtn = document.getElementById('boost');
  boostBtn.addEventListener('touchstart', e=>{ e.preventDefault(); boost=true; updateHUD(); }, {passive:false});
  boostBtn.addEventListener('mousedown', e=>{ e.preventDefault(); boost=true; updateHUD(); });
  function stopBoost(){ boost=false; updateHUD(); }
  document.addEventListener('touchend', stopBoost);
  document.addEventListener('mouseup', stopBoost);

  // Pause & restart
  bindBtn('pauseBtn', ()=>{ running=!running; updateHUD(); if(running) loop(); });
  bindBtn('restartBtn', ()=>{ reset(); });

  // Swipe
  let startTouch=null;
  canvas.addEventListener('touchstart',e=>{ startTouch = e.touches[0]; },{passive:true});
  canvas.addEventListener('touchmove',e=>{
    if(!startTouch) return;
    const t = e.touches[0], dx = t.clientX - startTouch.clientX, dy = t.clientY - startTouch.clientY;
    if(Math.abs(dx)+Math.abs(dy) > 30){
      if(Math.abs(dx) > Math.abs(dy)) setDir(Math.sign(dx),0); else setDir(0,Math.sign(dy));
      startTouch=null;
    }
  },{passive:true});
  canvas.addEventListener('touchend',()=>{ startTouch=null; });

  // Start immediately after first tap anywhere
  document.addEventListener('touchstart', function once(){
    reset(); loop();
    document.removeEventListener('touchstart', once);
  }, {once:true});
  document.addEventListener('mousedown', function once(){
    reset(); loop();
    document.removeEventListener('mousedown', once);
  }, {once:true});

  // Load best score
  best = +localStorage.snakeBest||0;
  bestEl.textContent = best;
})();
</script>
</body>
</html>
